# äº‹ä»¶æ¨¡å¼æ•™ç¨‹

[ä¸­æ–‡](index.md)|[English](index.en.md)

## æ•™ç¨‹

- [Component Tutorial](component-tutorial.en.md) | [ç»„ä»¶å¼€å‘æ•™ç¨‹ï¼ˆä¸­æ–‡ï¼‰](component-tutorial.md)
- [Multiprocessing Tutorial](multiprocessing-tutorial.en.md) | [å¤šè¿›ç¨‹æ•™ç¨‹ï¼ˆä¸­æ–‡ï¼‰](multiprocessing-tutorial.md)
- [Event Mode Tutorial](event-mode-tutorial.en.md) | [äº‹ä»¶æ¨¡å¼æ•™ç¨‹ï¼ˆä¸­æ–‡ï¼‰](event-mode-tutorial.md)
- [Logging Tutorial](logging-tutorial.en.md) | [æ—¥å¿—ä½¿ç”¨ï¼ˆä¸­æ–‡ï¼‰](logging-tutorial.md)

> **"åœ¨ Cellium ä¸­ï¼Œäº‹ä»¶æ˜¯ä¸€ç§æ›´è‡ªç”±çš„è¿æ¥æ–¹å¼â€”â€”ä½ åªéœ€è¦ä¸“æ³¨äºã€å‘ç”Ÿäº†ä»€ä¹ˆã€ï¼Œè€Œäº‹ä»¶çš„ä¼ æ’­ã€è·¯ç”±å’Œå“åº”ï¼Œéƒ½äº¤ç»™äº‹ä»¶æ€»çº¿ã€‚"**

> ğŸ’¡ **å‰ç½®æç¤º**ï¼šåœ¨å¼€å§‹å­¦ä¹ äº‹ä»¶æ¨¡å¼ä¹‹å‰ï¼Œå»ºè®®ä½ å…ˆç†Ÿæ‚‰ [ç»„ä»¶å¼€å‘æ•™ç¨‹](component-tutorial.md)ï¼Œäº†è§£ Cellium çš„åŸºæœ¬æ¶æ„å’Œå‘½ä»¤æ¨¡å¼ã€‚äº‹ä»¶æ¨¡å¼æ˜¯å‘½ä»¤æ¨¡å¼çš„è¡¥å……ï¼Œä¸¤è€…ç»“åˆä½¿ç”¨å¯ä»¥è®©ä½ çš„åº”ç”¨æ›´åŠ çµæ´»å’Œå¼ºå¤§ã€‚

æœ¬æ•™ç¨‹å°†å¸¦ä½ æ·±å…¥äº†è§£ Cellium ä¸­çš„**äº‹ä»¶æ¨¡å¼**ï¼ˆEvent Modeï¼‰ã€‚å¦‚æœè¯´å‘½ä»¤æ¨¡å¼æ˜¯ä¸€å¯¹ä¸€çš„å¯¹è®²æœºé€šä¿¡ï¼Œé‚£ä¹ˆäº‹ä»¶æ¨¡å¼å°±æ˜¯å¹¿æ’­ç”µå°â€”â€”ä¸€ä¸ªäº‹ä»¶å¯ä»¥åŒæ—¶è§¦å‘å¤šä¸ªå“åº”ã€‚æƒ³è±¡ä¸€ä¸‹ï¼šå½“ä½ å‘å¸ƒä¸€æ¡ã€Œç”¨æˆ·ç™»å½•æˆåŠŸã€çš„æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯æ—¥å¿—ç³»ç»Ÿå¯ä»¥è®°å½•å®ƒã€ç»Ÿè®¡æ•°æ®å¯ä»¥æ›´æ–°å®ƒã€é‚®ä»¶æœåŠ¡å¯ä»¥å‘é€æ¬¢è¿é‚®ä»¶â€”â€”æ‰€æœ‰è¿™äº›éƒ½å¯ä»¥åŒæ—¶å‘ç”Ÿï¼Œè€Œä½ åªéœ€è¦å‘å¸ƒä¸€æ¡äº‹ä»¶ï¼

## 1. ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶æ¨¡å¼ï¼Ÿ

åœ¨å®é™…çš„è½¯ä»¶å¼€å‘ä¸­ï¼Œä½ ç»å¸¸ä¼šé‡åˆ°è¿™æ ·çš„åœºæ™¯ï¼šä¸€ä¸ªæ“ä½œéœ€è¦è§¦å‘å¤šä¸ªä¸åŒçš„å“åº”ã€‚æ¯”å¦‚ç”¨æˆ·ä¸‹å•åï¼Œä½ éœ€è¦æ›´æ–°åº“å­˜ã€å‘é€é€šçŸ¥ã€è®°å½•æ—¥å¿—ã€åˆ·æ–°ç•Œé¢â€¦â€¦å¦‚æœç”¨å‘½ä»¤æ¨¡å¼ï¼Œä½ éœ€è¦é€ä¸ªè°ƒç”¨è¿™äº›åŠŸèƒ½ï¼Œä¸ä»…ä»£ç è€¦åˆåº¦é«˜ï¼Œè€Œä¸”æ¯æ¬¡æ·»åŠ æ–°åŠŸèƒ½éƒ½è¦ä¿®æ”¹åŸæœ‰ä»£ç ã€‚

äº‹ä»¶æ¨¡å¼å°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜è€Œç”Ÿçš„ã€‚å®ƒåŸºäº**å‘å¸ƒ-è®¢é˜…**ï¼ˆPublish-Subscribeï¼‰æ¨¡å¼ï¼Œè®©å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´ä¸éœ€è¦ç›´æ¥è®¤è¯†å¯¹æ–¹ã€‚å°±åƒä½ è®¢é˜…äº†ä¸€ä¸ªå¾®ä¿¡å…¬ä¼—å·ï¼Œå…¬ä¼—å·æ›´æ–°æ—¶ä¼šè‡ªåŠ¨æ¨é€æ¶ˆæ¯ç»™ä½ ï¼Œä½†ä½ ä¸éœ€è¦çŸ¥é“å…¬ä¼—å·æ˜¯æ€ä¹ˆè¿ä½œçš„ï¼Œå…¬ä¼—å·ä¹Ÿä¸éœ€è¦çŸ¥é“æœ‰å¤šå°‘äººè®¢é˜…äº†å®ƒã€‚

è¿™ç§æ¨¡å¼æœ‰å‡ ä¸ªæ˜¾è‘—çš„å¥½å¤„ï¼š

- **æ¾è€¦åˆ**ï¼šå‘å¸ƒè€…å’Œè®¢é˜…è€…äº’ä¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ï¼Œä½ å¯ä»¥éšæ„æ·»åŠ æˆ–ç§»é™¤è®¢é˜…è€…ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹å‘å¸ƒè€…çš„ä»£ç ã€‚
- **å¤šæ’­æ”¯æŒ**ï¼šä¸€ä¸ªäº‹ä»¶å¯ä»¥è¢«å¤šä¸ªå¤„ç†å™¨åŒæ—¶è®¢é˜…ï¼Œä¸€ä¸ªåŠ¨ä½œè§¦å‘å¤šä¸ªå“åº”å˜å¾—è½»è€Œæ˜“ä¸¾ã€‚
- **åŠ¨æ€ç®¡ç†**ï¼šå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ æˆ–ç§»é™¤äº‹ä»¶è®¢é˜…ï¼Œçµæ´»åº”å¯¹å„ç§åœºæ™¯ã€‚
- **å¹¿æ’­é€šä¿¡**ï¼šä¸€ä¸ªäº‹ä»¶å¯ä»¥è§¦å‘å¤šä¸ªä¸åŒçš„å“åº”åŠ¨ä½œï¼Œé€‚åˆå®ç°æ’ä»¶åŒ–æ¶æ„ã€‚

> ğŸ’¡ **ä»€ä¹ˆæ—¶å€™ç”¨äº‹ä»¶æ¨¡å¼ï¼Ÿ** å½“ä½ éœ€è¦ã€Œä¸€ä¸ªåŠ¨ä½œè§¦å‘å¤šä¸ªå“åº”ã€æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘äº‹ä»¶æ¨¡å¼ã€‚æ¯”å¦‚ç”¨æˆ·æ³¨å†Œåéœ€è¦å‘é€æ¬¢è¿é‚®ä»¶ã€åˆå§‹åŒ–ç”¨æˆ·æ•°æ®ã€è®°å½•æ³¨å†Œæ—¥å¿—ã€åˆ·æ–°æ¨èå†…å®¹ç­‰åœºæ™¯ã€‚

## 2. å¿«é€Ÿå…¥é—¨ï¼šç¬¬ä¸€ä¸ªäº‹ä»¶

è®©æˆ‘ä»¬ä»ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­å¼€å§‹ï¼Œæ„Ÿå—ä¸€ä¸‹äº‹ä»¶æ¨¡å¼çš„é­…åŠ›ã€‚é¦–å…ˆï¼Œä½ éœ€è¦å¯¼å…¥äº‹ä»¶ç›¸å…³çš„ APIï¼š

```python
from app.core.bus import event_bus, event  # å¯¼å…¥äº‹ä»¶æ€»çº¿å’Œäº‹ä»¶è£…é¥°å™¨
```

### 2.1 è®¢é˜…ä¸€ä¸ªäº‹ä»¶

ä½¿ç”¨ `@event()` è£…é¥°å™¨å¯ä»¥è½»æ¾è®¢é˜…äº‹ä»¶ã€‚å°±åƒç»™ä¸€ä¸ªå‡½æ•°è´´ä¸Šæ ‡ç­¾ï¼Œå‘Šè¯‰ç³»ç»Ÿã€Œå½“è¿™ä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¯·è°ƒç”¨æˆ‘ã€ï¼š

```python
from app.core.bus import event

@event("user.login")  # è®¢é˜… user.login äº‹ä»¶
def handle_user_login(**kwargs):
    """ç”¨æˆ·ç™»å½•äº‹ä»¶å¤„ç†å™¨"""
    username = kwargs.get("username", "æœªçŸ¥ç”¨æˆ·")  # ä»äº‹ä»¶æ•°æ®ä¸­è·å–ç”¨æˆ·å
    print(f"ç”¨æˆ· {username} å·²æˆåŠŸç™»å½•ï¼")
    print(f"ç™»å½•æ—¶é—´ï¼š{kwargs.get('login_time', 'æœªçŸ¥')}")
```

> ğŸ’¡ **å°è´´å£«**ï¼šäº‹ä»¶å¤„ç†å™¨çš„å‚æ•°ä½¿ç”¨ `**kwargs` æ¥æ”¶ï¼Œè¿™æ ·ä½ å¯ä»¥æ¥æ”¶ä»»æ„æ•°é‡çš„å‘½åå‚æ•°ï¼Œçµæ´»åº”å¯¹å„ç§äº‹ä»¶æ•°æ®ã€‚

### 2.2 å‘å¸ƒä¸€ä¸ªäº‹ä»¶

å‘å¸ƒäº‹ä»¶éå¸¸ç®€å•ï¼Œåªéœ€è¦è°ƒç”¨ `event_bus.publish()` æ–¹æ³•ï¼Œå¹¶ä¼ å…¥äº‹ä»¶åç§°å’Œè¦ä¼ é€’çš„æ•°æ®ï¼š

```python
from app.core.bus import event_bus

# è§¦å‘ç”¨æˆ·ç™»å½•äº‹ä»¶ï¼Œå¹¶ä¼ é€’ç›¸å…³æ•°æ®
event_bus.publish(
    "user.login",
    username="å¼ ä¸‰",
    login_time="2024-01-15 10:30:00",
    ip_address="192.168.1.100"
)
```

**æ‰§è¡Œç»“æœ**ï¼š
```
ç”¨æˆ· å¼ ä¸‰ å·²æˆåŠŸç™»å½•ï¼
ç™»å½•æ—¶é—´ï¼š2024-01-15 10:30:00
```

> ğŸ’¡ **å°è´´å£«**ï¼šä½ å¯ä»¥ä¼ é€’ä»»æ„ç±»å‹çš„æ•°æ®ç»™äº‹ä»¶ï¼Œäº‹ä»¶æ€»çº¿ä¼šå°†è¿™äº›æ•°æ®åŸå°ä¸åŠ¨åœ°ä¼ é€’ç»™æ‰€æœ‰è®¢é˜…è€…ã€‚

### 2.3 å®Œæ•´äº¤äº’æµç¨‹

ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„äº¤äº’æµç¨‹å›¾ï¼Œå¸®åŠ©ä½ ç†è§£äº‹ä»¶çš„æµåŠ¨æ–¹å‘ï¼š

```mermaid
flowchart LR
    A["å‘å¸ƒè€…<br/>event_bus.publish()"] --> B["äº‹ä»¶æ€»çº¿<br/>Event Bus"]
    B --> C["å¤„ç†å™¨1<br/>handle_user_login"]
    B --> D["å¤„ç†å™¨2<br/>send_welcome_email"]
    B --> E["å¤„ç†å™¨3<br/>update_statistics"]
    
    style B fill:#e1f5fe
    style A fill:#fff3e0
    style C fill:#e8f5e9
    style D fill:#fce4ec
    style E fill:#f3e5f5
```

## 3. æ·±å…¥æ¢ç´¢ï¼šæ›´å¤šè®¢é˜…æ–¹å¼

æŒæ¡äº†åŸºç¡€ä¹‹åï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹äº‹ä»¶æ¨¡å¼æä¾›çš„å„ç§å¼ºå¤§åŠŸèƒ½ã€‚

### 3.1 ä¸€æ¬¡æ€§äº‹ä»¶ï¼šåªæ‰§è¡Œä¸€æ¬¡çš„ç›‘å¬

æœ‰æ—¶å€™ä½ åªéœ€è¦ç›‘å¬ä¸€æ¬¡äº‹ä»¶ï¼Œäº‹ä»¶è§¦å‘åå°±ä¸å†éœ€è¦è¯¥å¤„ç†å™¨äº†ã€‚æ¯”å¦‚åº”ç”¨å¯åŠ¨æ—¶çš„åˆå§‹åŒ–æ“ä½œï¼Œåªéœ€è¦æ‰§è¡Œä¸€æ¬¡å°±å¤Ÿäº†ã€‚è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ `@event_once()` è£…é¥°å™¨ï¼š

```python
from app.core.bus import event_once

@event_once("app.startup")  # åªæ‰§è¡Œä¸€æ¬¡çš„å¯åŠ¨äº‹ä»¶
def initialize_application(**kwargs):
    """åº”ç”¨å¯åŠ¨åˆå§‹åŒ–"""
    print("[åˆå§‹åŒ–] åŠ è½½é…ç½®...")
    print("[åˆå§‹åŒ–] è¿æ¥æ•°æ®åº“...")
    print("[åˆå§‹åŒ–] å¯åŠ¨åå°ä»»åŠ¡...")
    print("[åˆå§‹åŒ–] åº”ç”¨å‡†å¤‡å°±ç»ªï¼")
```

> ğŸ’¡ **ä½¿ç”¨åœºæ™¯**ï¼šä¸€æ¬¡æ€§äº‹ä»¶éå¸¸é€‚åˆåˆå§‹åŒ–æ“ä½œã€é¦–æ¬¡è¿è¡Œå¼•å¯¼ã€ä¸€æ¬¡æ€§æ•°æ®åŠ è½½ç­‰åœºæ™¯ã€‚

ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨è®¢é˜…ä¸€æ¬¡æ€§äº‹ä»¶ï¼š

```python
from app.core.bus import event_bus

def database_connected(**kwargs):
    """æ•°æ®åº“è¿æ¥æˆåŠŸåæ‰§è¡Œ"""
    print(f"æ•°æ®åº“è¿æ¥æˆåŠŸï¼é©±åŠ¨ï¼š{kwargs.get('driver')}")

event_bus.subscribe_once("database.connected", database_connected)
```

### 3.2 æ¨¡å¼åŒ¹é…ï¼šä¸€ä¸ªè®¢é˜…å™¨ç›‘å¬ä¸€ç±»äº‹ä»¶

å¦‚æœä½ æƒ³ç›‘å¬æ‰€æœ‰ä»¥ã€Œuser.ã€å¼€å¤´çš„äº‹ä»¶è¯¥æ€ä¹ˆåŠï¼Ÿä¸€ä¸ªä¸€ä¸ªè®¢é˜…å¤ªéº»çƒ¦äº†ã€‚äº‹ä»¶æ¨¡å¼æä¾›äº†å¼ºå¤§çš„æ¨¡å¼åŒ¹é…åŠŸèƒ½ï¼Œä½¿ç”¨ `@event_pattern()` è£…é¥°å™¨ï¼š

```python
from app.core.bus import event_pattern

@event_pattern("user.*")  # ç›‘å¬æ‰€æœ‰ user. å¼€å¤´çš„ events
def handle_all_user_events(**kwargs):
    """å¤„ç†æ‰€æœ‰ç”¨æˆ·ç›¸å…³äº‹ä»¶"""
    event_name = kwargs.get("_event_name")  # äº‹ä»¶æ€»çº¿ä¼šè‡ªåŠ¨ä¼ å…¥äº‹ä»¶å
    print(f"æ”¶åˆ°ç”¨æˆ·äº‹ä»¶ï¼š{event_name}")
    
    # æ ¹æ®ä¸åŒäº‹ä»¶åšä¸åŒå¤„ç†
    if event_name == "user.login":
        print("â†’ ç”¨æˆ·ç™»å½•äº†")
    elif event_name == "user.logout":
        print("â†’ ç”¨æˆ·ç™»å‡ºäº†")
    elif event_name == "user.register":
        print("â†’ ç”¨æˆ·æ³¨å†Œäº†")
```

æ¨¡å¼åŒ¹é…æ”¯æŒä»¥ä¸‹é€šé…ç¬¦ï¼š

| é€šé…ç¬¦ | å«ä¹‰ | ç¤ºä¾‹ |
|--------|------|------|
| `*` | åŒ¹é…å•ä¸ªè¯ | `user.*` åŒ¹é… `user.login`ã€`user.logout` |
| `#` | åŒ¹é…å¤šä¸ªè¯ï¼ˆé›¶ä¸ªæˆ–å¤šä¸ªï¼‰ | `order.#.created` åŒ¹é… `order.created`ã€`order.item.created` |
| `?` | åŒ¹é…å•ä¸ªå­—ç¬¦ | `user.?` åŒ¹é… `user.a`ã€`user.1` |

> ğŸ’¡ **æ¨¡å¼åŒ¹é…ç¤ºä¾‹**ï¼š
> - `notification.*` åŒ¹é… `notification.email`ã€`notification.sms`ã€`notification.push`
> - `order.#.created` åŒ¹é… `order.created`ã€`order.item.created`ã€`order.package.item.created`
> - `data.?` åŒ¹é… `data.1`ã€`data.a`ã€`data.x`

### 3.3 é€šé…ç¬¦è®¢é˜…ï¼šç›‘å¬æ‰€æœ‰äº‹ä»¶

å¦‚æœä½ æƒ³ç›‘å¬ absolutely æ‰€æœ‰äº‹ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ `@event_wildcard()` è£…é¥°å™¨ã€‚è¿™åœ¨å®ç°æ—¥å¿—ç³»ç»Ÿã€è°ƒè¯•å·¥å…·æˆ–å…¨å±€ç›‘æ§æ—¶éå¸¸æœ‰ç”¨ï¼š

```python
from app.core.bus import event_wildcard

@event_wildcard()  # ç›‘å¬æ‰€æœ‰äº‹ä»¶
def global_event_logger(**kwargs):
    """è®°å½•æ‰€æœ‰äº‹ä»¶ï¼ˆç”¨äºè°ƒè¯•å’Œç›‘æ§ï¼‰"""
    event_name = kwargs.get("_event_name")
    # è¿‡æ»¤æ‰å†…éƒ¨å‚æ•°ï¼Œåªä¿ç•™ä¸šåŠ¡æ•°æ®
    event_data = {k: v for k, v in kwargs.items() if not k.startswith("_")}
    print(f"[å…¨å±€æ—¥å¿—] {event_name}ï¼š{event_data}")
```

> ğŸ’¡ **è°ƒè¯•æŠ€å·§**ï¼šåœ¨å¼€å‘é˜¶æ®µæ·»åŠ ä¸€ä¸ªé€šé…ç¬¦è®¢é˜…å™¨ï¼Œå¯ä»¥å¸®åŠ©ä½ äº†è§£æ•´ä¸ªåº”ç”¨çš„äº‹ä»¶æµï¼Œå¿«é€Ÿå®šä½é—®é¢˜ã€‚

### 3.4 ä¼˜å…ˆçº§æ§åˆ¶ï¼šè°å…ˆè°åæˆ‘è¯´äº†ç®—

å½“å¤šä¸ªå¤„ç†å™¨è®¢é˜…åŒä¸€ä¸ªäº‹ä»¶æ—¶ï¼Œä½ å¯èƒ½éœ€è¦æ§åˆ¶å®ƒä»¬çš„æ‰§è¡Œé¡ºåºã€‚äº‹ä»¶æ¨¡å¼æä¾›äº†ä¼˜å…ˆçº§æœºåˆ¶ï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼š

```python
from app.core.bus import event, EventPriority

@event("data.saved", priority=EventPriority.HIGHEST)  # æœ€é«˜ä¼˜å…ˆçº§
def validate_data_first(**kwargs):
    """æœ€å…ˆæ‰§è¡Œï¼šæ•°æ®éªŒè¯"""
    print("[1] éªŒè¯æ•°æ®æœ‰æ•ˆæ€§...")

@event("data.saved", priority=EventPriority.HIGH)
def process_data_second(**kwargs):
    """ç¬¬äºŒä¸ªæ‰§è¡Œï¼šæ•°æ®å¤„ç†"""
    print("[2] å¤„ç†æ•°æ®...")

@event("data.saved", priority=EventPriority.NORMAL)  # é»˜è®¤ä¼˜å…ˆçº§
def save_data_third(**kwargs):
    """ç¬¬ä¸‰ä¸ªæ‰§è¡Œï¼šä¿å­˜æ•°æ®"""
    print("[3] ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“...")

@event("data.saved", priority=EventPriority.LOW)
def log_data_last(**kwargs):
    """æœ€åæ‰§è¡Œï¼šè®°å½•æ—¥å¿—"""
    print("[4] è®°å½•æ“ä½œæ—¥å¿—...")
```

Cellium é¢„å®šä¹‰äº†äº”ä¸ªä¼˜å…ˆçº§çº§åˆ«ï¼š

| çº§åˆ« | å¸¸é‡ | å€¼ | é€‚ç”¨åœºæ™¯ |
|------|------|-----|----------|
| æœ€ä½ | `EventPriority.LOWEST` | 0 | æ—¥å¿—è®°å½•ã€ç›‘æ§ |
| ä½ | `EventPriority.LOW` | 100 | éå…³é”®åç»­å¤„ç† |
| ä¸­ | `EventPriority.NORMAL` | 500 | æ™®é€šä¸šåŠ¡é€»è¾‘ |
| é«˜ | `EventPriority.HIGH` | 1000 | æ ¸å¿ƒä¸šåŠ¡å¤„ç† |
| æœ€é«˜ | `EventPriority.HIGHEST` | 10000 | éªŒè¯ã€æ‹¦æˆª |

> ğŸ’¡ **ä¼˜å…ˆçº§å»ºè®®**ï¼šéµå¾ªã€ŒéªŒè¯å…ˆäºå¤„ç†ã€å¤„ç†å…ˆäºä¿å­˜ã€ä¿å­˜å…ˆäºæ—¥å¿—ã€çš„åŸåˆ™ï¼Œè®©æ•°æ®æµæ›´åŠ å®‰å…¨å’Œå¯æ§ã€‚

## 4. å‘å¸ƒäº‹ä»¶çš„å¤šç§æ–¹å¼

å­¦ä¼šäº†è®¢é˜…äº‹ä»¶ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å‘å¸ƒäº‹ä»¶ã€‚Cellium æä¾›äº†å¤šç§å‘å¸ƒäº‹ä»¶çš„æ–¹å¼ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯çš„éœ€æ±‚ã€‚

### 4.1 ç›´æ¥å‘å¸ƒï¼šä½¿ç”¨ event_bus.publish()

æœ€ç›´æ¥çš„æ–¹å¼æ˜¯é€šè¿‡ `event_bus.publish()` æ–¹æ³•å‘å¸ƒäº‹ä»¶ï¼Œå¯ä»¥ä¼ é€’ä»»æ„ç±»å‹çš„æ•°æ®ï¼š

```python
from app.core.bus import event_bus

# å‘å¸ƒç®€å•äº‹ä»¶
event_bus.publish("user.login", username="å°æ˜", role="ç®¡ç†å‘˜")

# å‘å¸ƒå¸¦å¤æ‚æ•°æ®çš„äº‹ä»¶
event_bus.publish(
    "order.created",
    order_id="ORD-2024-0001",
    customer_id="C001",
    items=[
        {"product_id": "P001", "name": "Pythonç¼–ç¨‹æŒ‡å—", "quantity": 1, "price": 89.00},
        {"product_id": "P002", "name": "Flaskå®æˆ˜æ•™ç¨‹", "quantity": 2, "price": 128.00}
    ],
    total_amount=345.00,
    payment_method="å¾®ä¿¡æ”¯ä»˜",
    shipping_address="åŒ—äº¬å¸‚æµ·æ·€åŒºxxxè·¯xxxå·"
)
```

### 4.2 è‡ªåŠ¨å‘å¸ƒï¼šä½¿ç”¨ @emitter è£…é¥°å™¨

å¦‚æœä½ å¸Œæœ›æŸä¸ªæ–¹æ³•åœ¨æ‰§è¡Œæ—¶è‡ªåŠ¨è§¦å‘äº‹ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ `@emitter()` è£…é¥°å™¨ã€‚è¿™è®©ä½ çš„ä¸šåŠ¡ä»£ç æ›´åŠ ç®€æ´ï¼Œä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `publish()`ï¼š

```python
from app.core.bus import emitter, event

class UserService:
    """ç”¨æˆ·æœåŠ¡ç»„ä»¶"""
    
    def __init__(self):
        self.users = {}
    
    @emitter("user.registered")  # æ–¹æ³•æ‰§è¡Œåè‡ªåŠ¨è§¦å‘äº‹ä»¶
    def register_user(self, username: str, email: str, password: str) -> bool:
        """æ³¨å†Œæ–°ç”¨æˆ·ï¼ŒæˆåŠŸæ—¶è§¦å‘äº‹ä»¶"""
        if username in self.users:
            print(f"ç”¨æˆ·å {username} å·²å­˜åœ¨")
            return False
        
        self.users[username] = {
            "email": email,
            "registered_at": "2024-01-15",
            "status": "active"
        }
        print(f"ç”¨æˆ· {username} æ³¨å†ŒæˆåŠŸ")
        return True
    
    @emitter("user.login")
    def login(self, username: str, password: str) -> bool:
        """ç”¨æˆ·ç™»å½•ï¼ŒæˆåŠŸæ—¶è§¦å‘äº‹ä»¶"""
        if username not in self.users:
            print(f"ç”¨æˆ·ä¸å­˜åœ¨")
            return False
        
        print(f"ç”¨æˆ· {username} ç™»å½•æˆåŠŸ")
        return True

# ä½¿ç”¨ç¤ºä¾‹
user_service = UserService()

# æ³¨å†Œç”¨æˆ·ï¼ˆä¼šè‡ªåŠ¨è§¦å‘ user.registered äº‹ä»¶ï¼‰
user_service.register_user("å¼ ä¸‰", "zhangsan@email.com", "password123")

# ç™»å½•ï¼ˆä¼šè‡ªåŠ¨è§¦å‘ user.login äº‹ä»¶ï¼‰
user_service.login("å¼ ä¸‰", "password123")
```

> ğŸ’¡ **ä½¿ç”¨æŠ€å·§**ï¼šä½¿ç”¨ `@emitter` è£…é¥°å™¨æ—¶ï¼Œæ–¹æ³•çš„æ‰€æœ‰å‚æ•°ä¼šè‡ªåŠ¨ä¼ é€’ç»™äº‹ä»¶è®¢é˜…è€…ï¼Œä½ å¯ä»¥åœ¨è®¢é˜…å™¨ä¸­é€šè¿‡ `kwargs` è·å–è¿™äº›å‚æ•°ã€‚

### 4.3 æ¡ä»¶å‘å¸ƒï¼šåªåœ¨æ»¡è¶³æ¡ä»¶æ—¶è§¦å‘äº‹ä»¶

æœ‰äº›åœºæ™¯ä¸‹ï¼Œä½ å¸Œæœ›åªåœ¨æ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶æ‰å‘å¸ƒäº‹ä»¶ã€‚è¿™å¯ä»¥é€šè¿‡åœ¨ä»£ç ä¸­åŠ å…¥æ¡ä»¶åˆ¤æ–­æ¥å®ç°ï¼š

```python
from app.core.bus import event, event_bus

@event("order.paid")
def handle_order_paid(**kwargs):
    """è®¢å•æ”¯ä»˜æˆåŠŸå¤„ç†"""
    order_id = kwargs.get("order_id")
    print(f"[é€šçŸ¥] è®¢å• {order_id} æ”¯ä»˜æˆåŠŸï¼Œå°†å‘é€ç¡®è®¤é‚®ä»¶")

class PaymentService:
    """æ”¯ä»˜æœåŠ¡"""
    
    def process_payment(self, order_id: str, amount: float, payment_method: str):
        """å¤„ç†æ”¯ä»˜"""
        # æ¨¡æ‹Ÿæ”¯ä»˜é€»è¾‘
        payment_success = True  # è¿™é‡Œæ˜¯ä½ çš„æ”¯ä»˜é€»è¾‘
        
        # åªåœ¨æ”¯ä»˜æˆåŠŸæ—¶å‘å¸ƒäº‹ä»¶
        if payment_success:
            event_bus.publish(
                "order.paid",
                order_id=order_id,
                amount=amount,
                payment_method=payment_method,
                paid_at="2024-01-15 10:30:00"
            )
            print(f"è®¢å• {order_id} æ”¯ä»˜æˆåŠŸï¼Œå·²å‘å¸ƒäº‹ä»¶")
        else:
            print(f"è®¢å• {order_id} æ”¯ä»˜å¤±è´¥")
```

## 5. å‘½åç©ºé—´ï¼šé˜²æ­¢äº‹ä»¶åå†²çªçš„åˆ©å™¨

å½“ä½ çš„åº”ç”¨å˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªæ¨¡å—éƒ½å®šä¹‰äº†è‡ªå·±çš„äº‹ä»¶ã€‚å¦‚æœä¸å°å¿ƒä½¿ç”¨äº†ç›¸åŒçš„äº‹ä»¶åï¼Œå°±ä¼šé€ æˆæ··ä¹±ã€‚å‘½åç©ºé—´å°±æ˜¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚

### 5.1 ä»€ä¹ˆæ˜¯å‘½åç©ºé—´ï¼Ÿ

å‘½åç©ºé—´å°±åƒç»™äº‹ä»¶ååŠ ä¸Šä¸€ä¸ªå‰ç¼€ï¼ŒæŠŠäº‹ä»¶åˆ†ç±»ç®¡ç†ã€‚æ¯”å¦‚ã€Œç”¨æˆ·ç™»å½•ã€äº‹ä»¶ï¼Œåœ¨ç”¨æˆ·æ¨¡å—ä¸­å¯ä»¥ç”¨ `user.login`ï¼Œåœ¨è®¢å•æ¨¡å—ä¸­ä¹Ÿå¯ä»¥ç”¨ `user.login`ï¼ˆè™½ç„¶å«ä¹‰ä¸åŒï¼‰ï¼Œä½†å¦‚æœä¸¤ä¸ªæ¨¡å—åŒæ—¶å­˜åœ¨ï¼Œå°±ä¼šäº§ç”Ÿå†²çªã€‚

ä½¿ç”¨å‘½åç©ºé—´åï¼Œä½ å¯ä»¥è¿™æ ·åŒºåˆ†ï¼š

| äº‹ä»¶å | å«ä¹‰ |
|--------|------|
| `user.login` | ç”¨æˆ·æ¨¡å—çš„ç”¨æˆ·ç™»å½• |
| `notification.user.login` | é€šçŸ¥æ¨¡å—ç›‘å¬çš„ç”¨æˆ·ç™»å½• |
| `analytics.user.login` | åˆ†ææ¨¡å—ç›‘å¬çš„ç”¨æˆ·ç™»å½• |

### 5.2 ä½¿ç”¨å‘½åç©ºé—´

ä½¿ç”¨ `set_event_namespace()` å‡½æ•°å¯ä»¥è®¾ç½®å…¨å±€å‘½åç©ºé—´å‰ç¼€ï¼š

```python
from app.core.bus import event, set_event_namespace

# è®¾ç½®å‘½åç©ºé—´
set_event_namespace("shop")

@event("order.created")  # å®é™…è®¢é˜…çš„æ˜¯ "shop.order.created"
def handle_order_created(**kwargs):
    order_id = kwargs.get("order_id")
    print(f"[å•†åº—] è®¢å• {order_id} å·²åˆ›å»º")
```

å‘å¸ƒäº‹ä»¶æ—¶ï¼Œå‘½åç©ºé—´å‰ç¼€ä¼šè‡ªåŠ¨æ·»åŠ ï¼š

```python
from app.core.bus import event_bus

event_bus.publish("order.created", order_id="ORD-001")  # å®é™…å‘å¸ƒçš„æ˜¯ "shop.order.created"
event_bus.publish("order.cancelled", order_id="ORD-001")  # å®é™…å‘å¸ƒçš„æ˜¯ "shop.order.cancelled"
```

> ğŸ’¡ **å‘½åç©ºé—´å»ºè®®**ï¼šä¸ºæ¯ä¸ªä¸»è¦æ¨¡å—è®¾ç½®ç‹¬ç«‹çš„å‘½åç©ºé—´ï¼Œå¦‚ `user`ã€`order`ã€`notification`ã€`analytics` ç­‰ï¼Œè®©äº‹ä»¶åæ›´åŠ æ¸…æ™°å’Œæœ‰åºã€‚

### 5.3 å‘½åç©ºé—´å®æˆ˜

å‡è®¾æˆ‘ä»¬æ­£åœ¨å¼€å‘ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼Œä¸åŒæ¨¡å—ä½¿ç”¨ä¸åŒçš„å‘½åç©ºé—´ï¼š

```python
from app.core.bus import event, event_bus, set_event_namespace

# ==================== ç”¨æˆ·æ¨¡å— ====================
set_event_namespace("user")

@event("login")
def user_login_handler(**kwargs):
    """ç”¨æˆ·æ¨¡å—ï¼šå¤„ç†ç”¨æˆ·ç™»å½•"""
    print(f"[ç”¨æˆ·æ¨¡å—] ç”¨æˆ· {kwargs.get('username')} ç™»å½•äº†")

@event("register")
def user_register_handler(**kwargs):
    """ç”¨æˆ·æ¨¡å—ï¼šå¤„ç†ç”¨æˆ·æ³¨å†Œ"""
    print(f"[ç”¨æˆ·æ¨¡å—] æ–°ç”¨æˆ·æ³¨å†Œï¼š{kwargs.get('email')}")

# ==================== è®¢å•æ¨¡å— ====================
set_event_namespace("order")

@event("created")
def order_created_handler(**kwargs):
    """è®¢å•æ¨¡å—ï¼šå¤„ç†è®¢å•åˆ›å»º"""
    print(f"[è®¢å•æ¨¡å—] æ–°è®¢å•ï¼š{kwargs.get('order_id')}")

@event("paid")
def order_paid_handler(**kwargs):
    """è®¢å•æ¨¡å—ï¼šå¤„ç†è®¢å•æ”¯ä»˜"""
    print(f"[è®¢å•æ¨¡å—] è®¢å•å·²æ”¯ä»˜ï¼š{kwargs.get('order_id')}")
```

å‘å¸ƒäº‹ä»¶æ—¶ï¼š

```python
# ç”¨æˆ·æ¨¡å—çš„äº‹ä»¶
event_bus.publish("user.login", username="å¼ ä¸‰")
event_bus.publish("user.register", email="zhangsan@email.com")

# è®¢å•æ¨¡å—çš„äº‹ä»¶
event_bus.publish("order.created", order_id="ORD-001")
event_bus.publish("order.paid", order_id="ORD-001")
```

**æ‰§è¡Œç»“æœ**ï¼š
```
[ç”¨æˆ·æ¨¡å—] ç”¨æˆ· å¼ ä¸‰ ç™»å½•äº†
[ç”¨æˆ·æ¨¡å—] æ–°ç”¨æˆ·æ³¨å†Œï¼šzhangsan@email.com
[è®¢å•æ¨¡å—] æ–°è®¢å•ï¼šORD-001
[è®¢å•æ¨¡å—] è®¢å•å·²æ”¯ä»˜ï¼šORD-001
```

## 6. æ¨¡å¼å¯¹æ¯”ï¼šå‘½ä»¤æ¨¡å¼ vs äº‹ä»¶æ¨¡å¼

ä½ å¯èƒ½ä¼šé—®ï¼šå‘½ä»¤æ¨¡å¼å’Œäº‹ä»¶æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæˆ‘åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨å“ªç§æ¨¡å¼ï¼Ÿè®©æˆ‘ä»¬æ¥åšä¸€ä¸ªè¯¦ç»†çš„å¯¹æ¯”ï¼š

| ç‰¹æ€§ | å‘½ä»¤æ¨¡å¼ | äº‹ä»¶æ¨¡å¼ |
|------|---------|---------|
| **é€šä¿¡æ–¹å¼** | å‰ç«¯ â†’ åç«¯ç»„ä»¶ï¼ˆä¸€å¯¹ä¸€ï¼‰ | å‰ç«¯ â†’ EventBus â†’ å¤šä¸ªè®¢é˜…è€…ï¼ˆä¸€å¯¹å¤šï¼‰ |
| **è¿”å›å€¼** | æœ‰ï¼ˆåŒæ­¥å“åº”ï¼‰ | æ— ï¼ˆå¼‚æ­¥é€šçŸ¥ï¼‰ |
| **è€¦åˆåº¦** | è¾ƒé«˜ï¼ˆè°ƒç”¨è€…çŸ¥é“è¢«è°ƒç”¨è€…ï¼‰ | ä½ï¼ˆå‘å¸ƒè€…å’Œè®¢é˜…è€…äº’ä¸çŸ¥æƒ…ï¼‰ |
| **çµæ´»æ€§** | æ·»åŠ æ–°åŠŸèƒ½éœ€è¦ä¿®æ”¹è°ƒç”¨æ–¹ | æ·»åŠ æ–°åŠŸèƒ½åªéœ€æ·»åŠ æ–°è®¢é˜…è€… |
| **é€‚ç”¨åœºæ™¯** | è¯·æ±‚-å“åº”ã€éœ€è¦è¿”å›å€¼çš„åœºæ™¯ | è§£è€¦é€šçŸ¥ã€ä¸€ä¸ªåŠ¨ä½œè§¦å‘å¤šä¸ªå“åº” |

> ğŸ’¡ **å¦‚ä½•é€‰æ‹©ï¼Ÿ**
> - éœ€è¦ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åè·å–ç»“æœ â†’ ç”¨å‘½ä»¤æ¨¡å¼
> - ç”¨æˆ·æ“ä½œåéœ€è¦åŒæ—¶æ›´æ–°å¤šä¸ªç•Œé¢ â†’ ç”¨äº‹ä»¶æ¨¡å¼
> - ç»„ä»¶ä¹‹é—´éœ€è¦é€šä¿¡ä½†ä¸åº”è¯¥ç›´æ¥å¼•ç”¨ â†’ ç”¨äº‹ä»¶æ¨¡å¼
> - ç®€å•çš„ CRUD æ“ä½œ â†’ ç”¨å‘½ä»¤æ¨¡å¼

## 7. å®æˆ˜æ¼”ç»ƒï¼šå®Œæ•´çš„ç”µå•†äº‹ä»¶ç³»ç»Ÿ

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ï¼Œå°†å‰é¢å­¦åˆ°çš„æ‰€æœ‰çŸ¥è¯†ç»¼åˆè¿ç”¨èµ·æ¥ã€‚è¿™ä¸ªç¤ºä¾‹æ¨¡æ‹Ÿäº†ä¸€ä¸ªç”µå•†ç³»ç»Ÿä¸­çš„äº‹ä»¶æµç¨‹ï¼š

```python
from app.core.bus import (
    event, event_once, event_pattern, event_wildcard,
    emitter, event_bus, EventPriority
)

# ==================== 1. å®šä¹‰äº‹ä»¶è®¢é˜…å™¨ ====================

# é«˜ä¼˜å…ˆçº§çš„éªŒè¯å¤„ç†å™¨
@event("order.create", priority=EventPriority.HIGHEST)
def validate_order(**kwargs):
    """éªŒè¯è®¢å•æ•°æ®ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰"""
    order_id = kwargs.get("order_id")
    items = kwargs.get("items", [])
    print(f"[éªŒè¯] æ£€æŸ¥è®¢å• {order_id} çš„æ•°æ®...")
    if not items:
        print("[éªŒè¯] è®¢å•æ²¡æœ‰å•†å“ï¼ŒéªŒè¯å¤±è´¥")
        return False
    print("[éªŒè¯] è®¢å•æ•°æ®éªŒè¯é€šè¿‡")
    return True

# æ™®é€šä¼˜å…ˆçº§çš„è®¢å•å¤„ç†å™¨
@event("order.create", priority=EventPriority.NORMAL)
def create_order_record(**kwargs):
    """åˆ›å»ºè®¢å•è®°å½•"""
    order_id = kwargs.get("order_id")
    customer = kwargs.get("customer")
    print(f"[è®¢å•] åˆ›å»ºè®¢å•è®°å½•ï¼š{order_id}ï¼Œå®¢æˆ·ï¼š{customer}")

# åº“å­˜å¤„ç†å™¨
@event("order.create")
def reserve_inventory(**kwargs):
    """é¢„ç•™åº“å­˜"""
    order_id = kwargs.get("order_id")
    items = kwargs.get("items", [])
    print(f"[åº“å­˜] ä¸ºè®¢å• {order_id} é¢„ç•™åº“å­˜ï¼š")
    for item in items:
        print(f"       - {item['name']} x {item['quantity']}")

# ä½ä¼˜å…ˆçº§çš„æ—¥å¿—å¤„ç†å™¨
@event("order.create", priority=EventPriority.LOW)
def log_order_creation(**kwargs):
    """è®°å½•è®¢å•åˆ›å»ºæ—¥å¿—"""
    order_id = kwargs.get("order_id")
    print(f"[æ—¥å¿—] è®¢å• {order_id} åˆ›å»ºå®Œæˆ")

# ä¸€æ¬¡æ€§äº‹ä»¶ï¼šåº”ç”¨é¦–æ¬¡å¯åŠ¨
@event_once("app.first_start")
def first_start_initialization(**kwargs):
    """åº”ç”¨é¦–æ¬¡å¯åŠ¨åˆå§‹åŒ–"""
    print("[åˆå§‹åŒ–] é¦–æ¬¡å¯åŠ¨ï¼Œæ‰§è¡Œåˆå§‹åŒ–é…ç½®...")
    print("[åˆå§‹åŒ–] åŠ è½½é»˜è®¤åˆ†ç±»...")
    print("[åˆå§‹åŒ–] è®¾ç½®é»˜è®¤å‚æ•°...")

# æ¨¡å¼åŒ¹é…ï¼šç›‘å¬æ‰€æœ‰è®¢å•ç›¸å…³äº‹ä»¶
@event_pattern("order.*")
def handle_all_order_events(**kwargs):
    """å¤„ç†æ‰€æœ‰è®¢å•äº‹ä»¶"""
    event_name = kwargs.get("_event_name")
    print(f"[ç›‘æ§] æ•è·è®¢å•äº‹ä»¶ï¼š{event_name}")

# é€šé…ç¬¦ï¼šç›‘å¬æ‰€æœ‰äº‹ä»¶ç”¨äºç»Ÿè®¡
@event_wildcard(priority=EventPriority.LOWEST)
def event_statistics(**kwargs):
    """äº‹ä»¶ç»Ÿè®¡ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼Œæœ€åæ‰§è¡Œï¼‰"""
    event_name = kwargs.get("_event_name")
    print(f"[ç»Ÿè®¡] äº‹ä»¶è®¡æ•°å™¨ï¼š{event_name}")


# ==================== 2. å®šä¹‰äº‹ä»¶å‘å¸ƒç±» ====================

class OrderService:
    """è®¢å•æœåŠ¡ç»„ä»¶"""
    
    def __init__(self):
        self.order_counter = 0
    
    @emitter("order.create")
    def create_order(self, customer: str, items: list):
        """åˆ›å»ºæ–°è®¢å•"""
        self.order_counter += 1
        order_id = f"ORD-{self.order_counter:04d}"
        
        print(f"\n>>> æ­£åœ¨åˆ›å»ºè®¢å• {order_id}...")
        
        return {
            "order_id": order_id,
            "customer": customer,
            "items": items
        }


# ==================== 3. æ‰§è¡Œæ¼”ç¤º ====================

if __name__ == "__main__":
    print("=" * 60)
    print("ç”µå•†äº‹ä»¶ç³»ç»Ÿæ¼”ç¤º")
    print("=" * 60)
    
    # è§¦å‘ä¸€æ¬¡æ€§äº‹ä»¶
    print("\nã€æ­¥éª¤1ã€‘åº”ç”¨é¦–æ¬¡å¯åŠ¨")
    event_bus.publish("app.first_start")
    
    # åˆ›å»ºè®¢å•æœåŠ¡
    order_service = OrderService()
    
    # åˆ›å»ºè®¢å•ï¼ˆä¼šè§¦å‘ order.create äº‹ä»¶ï¼‰
    print("\nã€æ­¥éª¤2ã€‘åˆ›å»ºç¬¬ä¸€ä¸ªè®¢å•")
    order_service.create_order(
        customer="å¼ ä¸‰",
        items=[
            {"name": "Pythonç¼–ç¨‹æŒ‡å—", "quantity": 1, "price": 89.00},
            {"name": "Flaskå®æˆ˜æ•™ç¨‹", "quantity": 2, "price": 128.00}
        ]
    )
    
    print("\nã€æ­¥éª¤3ã€‘åˆ›å»ºç¬¬äºŒä¸ªè®¢å•")
    order_service.create_order(
        customer="æå››",
        items=[
            {"name": "Djangoä¼ä¸šå¼€å‘å®æˆ˜", "quantity": 1, "price": 159.00}
        ]
    )
    
    print("\n" + "=" * 60)
    print("æ¼”ç¤ºç»“æŸ")
    print("=" * 60)
```

**æ‰§è¡Œç»“æœ**ï¼š
```
============================================================
ç”µå•†äº‹ä»¶ç³»ç»Ÿæ¼”ç¤º
============================================================

ã€æ­¥éª¤1ã€‘åº”ç”¨é¦–æ¬¡å¯åŠ¨
[åˆå§‹åŒ–] é¦–æ¬¡å¯åŠ¨ï¼Œæ‰§è¡Œåˆå§‹åŒ–é…ç½®...
[åˆå§‹åŒ–] åŠ è½½é»˜è®¤åˆ†ç±»...
[åˆå§‹åŒ–] è®¾ç½®é»˜è®¤å‚æ•°...

ã€æ­¥éª¤2ã€‘åˆ›å»ºç¬¬ä¸€ä¸ªè®¢å•

>>> æ­£åœ¨åˆ›å»ºè®¢å• ORD-0001...
[éªŒè¯] æ£€æŸ¥è®¢å• ORD-0001 çš„æ•°æ®...
[éªŒè¯] è®¢å•æ•°æ®éªŒè¯é€šè¿‡
[è®¢å•] åˆ›å»ºè®¢å•è®°å½•ï¼šORD-0001ï¼Œå®¢æˆ·ï¼šå¼ ä¸‰
[åº“å­˜] ä¸ºè®¢å• ORD-0001 é¢„ç•™åº“å­˜ï¼š
       - Pythonç¼–ç¨‹æŒ‡å— x 1
       - Flaskå®æˆ˜æ•™ç¨‹ x 2
[æ—¥å¿—] è®¢å• ORD-0001 åˆ›å»ºå®Œæˆ
[ç›‘æ§] æ•è·è®¢å•äº‹ä»¶ï¼šorder.create
[ç»Ÿè®¡] äº‹ä»¶è®¡æ•°å™¨ï¼šorder.create

ã€æ­¥éª¤3ã€‘åˆ›å»ºç¬¬äºŒä¸ªè®¢å•

>>> æ­£åœ¨åˆ›å»ºè®¢å• ORD-0002...
[éªŒè¯] æ£€æŸ¥è®¢å• ORD-0002 çš„æ•°æ®...
[éªŒè¯] è®¢å•æ•°æ®éªŒè¯é€šè¿‡
[è®¢å•] åˆ›å»ºè®¢å•è®°å½•ï¼šORD-0002ï¼Œå®¢æˆ·ï¼šæå››
[åº“å­˜] ä¸ºè®¢å• ORD-0002 é¢„ç•™åº“å­˜ï¼š
       - Djangoä¼ä¸šå¼€å‘å®æˆ˜ x 1
[æ—¥å¿—] è®¢å• ORD-0002 åˆ›å»ºå®Œæˆ
[ç›‘æ§] æ•è·è®¢å•äº‹ä»¶ï¼šorder.create
[ç»Ÿè®¡] äº‹ä»¶è®¡æ•°å™¨ï¼šorder.create

============================================================
æ¼”ç¤ºç»“æŸ
============================================================
```

> ğŸ’¡ **è§‚å¯Ÿæ‰§è¡Œé¡ºåº**ï¼šä½ å¯ä»¥çœ‹åˆ°å¤„ç†å™¨æŒ‰ç…§ä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ‰§è¡Œï¼šé«˜ä¼˜å…ˆçº§çš„éªŒè¯æœ€å…ˆæ‰§è¡Œï¼Œä½ä¼˜å…ˆçº§çš„æ—¥å¿—æœ€åæ‰§è¡Œã€‚è¿™å°±æ˜¯ä¼˜å…ˆçº§æ§åˆ¶çš„ä½œç”¨ã€‚

## 8. å‰ç«¯å¦‚ä½•å‘å¸ƒäº‹ä»¶

é™¤äº†åç«¯ç»„ä»¶å¯ä»¥å‘å¸ƒäº‹ä»¶ï¼Œå‰ç«¯ä¹Ÿå¯ä»¥é€šè¿‡ `window.mbQuery()` æ¥å£ç›´æ¥å‘äº‹ä»¶æ€»çº¿å‘é€äº‹ä»¶ã€‚è¿™æ˜¯å®ç°å‰åç«¯è§£è€¦é€šä¿¡çš„é‡è¦æ–¹å¼ã€‚

### 8.1 ä½¿ç”¨ window.mbQuery å‘å¸ƒäº‹ä»¶

äº‹ä»¶æ€»çº¿çš„å‘½ä»¤æ ¼å¼ä¸º `bus:publish:äº‹ä»¶å:JSONæ•°æ®`ï¼š

```javascript
// å‘å¸ƒç”¨æˆ·ç™»å½•äº‹ä»¶
window.mbQuery(0, 'bus:publish:user.login:{"username":"å¼ ä¸‰","role":"ç®¡ç†å‘˜"}', function(){});

// å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
window.mbQuery(0, 'bus:publish:order.created:{"order_id":"ORD-001","items":[{"name":"å•†å“A","quantity":1}]}', function(){});
```

### 8.2 å‰ç«¯äº‹ä»¶å‘å¸ƒç¤ºä¾‹

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>äº‹ä»¶æ¨¡å¼å‰ç«¯ç¤ºä¾‹</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .event-log { 
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-item {
            padding: 8px;
            margin: 5px 0;
            background-color: white;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>å‰ç«¯äº‹ä»¶å‘å¸ƒç¤ºä¾‹</h1>
    
    <div>
        <button onclick="publishUserLogin()">å‘å¸ƒç”¨æˆ·ç™»å½•äº‹ä»¶</button>
        <button onclick="publishOrderCreated()">å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶</button>
        <button onclick="publishCustomEvent()">å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶</button>
    </div>
    
    <div class="event-log" id="eventLog">
        <div style="color: #666;">äº‹ä»¶æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
    </div>
    
    <script>
        function logEvent(message) {
            var logDiv = document.getElementById('eventLog');
            var time = new Date().toLocaleTimeString();
            var logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `<strong>[${time}]</strong> ${message}`;
            logDiv.insertBefore(logItem, logDiv.firstChild);
        }
        
        function publishUserLogin() {
            var username = prompt("è¯·è¾“å…¥ç”¨æˆ·åï¼š", "å¼ ä¸‰");
            if (username) {
                window.mbQuery(0, 'bus:publish:user.login:{"username":"' + username + '","login_time":"' + new Date().toLocaleString() + '"}', function(){});
                logEvent(`å‘å¸ƒ user.login äº‹ä»¶ï¼Œç”¨æˆ·ï¼š${username}`);
            }
        }
        
        function publishOrderCreated() {
            var orderData = JSON.stringify({
                order_id: "ORD-" + Date.now().toString().slice(-6),
                customer: "ç‹äº”",
                items: [
                    {name: "å•†å“A", quantity: 1, price: 99.00},
                    {name: "å•†å“B", quantity: 2, price: 49.00}
                ],
                total_amount: 197.00
            });
            window.mbQuery(0, 'bus:publish:order.created:' + orderData, function(){});
            logEvent(`å‘å¸ƒ order.created äº‹ä»¶ï¼Œè®¢å•æ•°æ®å·²å‘é€`);
        }
        
        function publishCustomEvent() {
            var eventName = prompt("è¯·è¾“å…¥äº‹ä»¶åï¼š", "my.custom.event");
            var eventData = prompt("è¯·è¾“å…¥äº‹ä»¶æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰ï¼š", '{"message":"Hello Event"}');
            if (eventName && eventData) {
                window.mbQuery(0, 'bus:publish:' + eventName + ':' + eventData, function(){});
                logEvent(`å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶ï¼š${eventName}`);
            }
        }
    </script>
</body>
</html>
```

## 9. å¸¸è§é—®é¢˜

**é—®ï¼šäº‹ä»¶å¤„ç†å™¨æ¥æ”¶ä¸åˆ°æ•°æ®æ€ä¹ˆåŠï¼Ÿ**

é¦–å…ˆæ£€æŸ¥äº‹ä»¶åæ˜¯å¦å®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬å¤§å°å†™ï¼‰ã€‚ç„¶åç¡®è®¤ `publish` æ—¶ä¼ é€’çš„å‚æ•°åä¸ `kwargs.get()` ä¸­ä½¿ç”¨çš„å‚æ•°åä¸€è‡´ã€‚å¦‚æœä½¿ç”¨ `@event_pattern` æˆ– `@event_wildcard`ï¼Œåˆ«å¿˜äº†é€šè¿‡ `kwargs.get("_event_name")` è·å–äº‹ä»¶åã€‚

**é—®ï¼šäº‹ä»¶è§¦å‘äº†ä½†å¤„ç†å™¨æ²¡æœ‰æ‰§è¡Œï¼Ÿ**

å¯èƒ½çš„åŸå› æœ‰ï¼šå¤„ç†å™¨è¿˜æ²¡æœ‰æ³¨å†Œå°±è¢«è§¦å‘äº†ï¼ˆç¡®ä¿å…ˆæ³¨å†Œå¤„ç†å™¨å†å‘å¸ƒäº‹ä»¶ï¼‰ã€ä¸€æ¬¡æ€§äº‹ä»¶å·²ç»è¢«è§¦å‘è¿‡äº†ï¼ˆä¸€æ¬¡æ€§äº‹ä»¶åªèƒ½è§¦å‘ä¸€æ¬¡ï¼‰ã€å¤„ç†å™¨åœ¨æ³¨å†Œåå‘ç”Ÿäº†å¼‚å¸¸ï¼ˆæ£€æŸ¥æ—¥å¿—è¾“å‡ºï¼‰ã€‚

**é—®ï¼šå¦‚ä½•å–æ¶ˆè®¢é˜…äº‹ä»¶ï¼Ÿ**

ä½¿ç”¨ `event_bus.unsubscribe()` æ–¹æ³•å–æ¶ˆè®¢é˜…ï¼š

```python
from app.core.bus import event_bus

def temporary_handler(**kwargs):
    print("è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶å¤„ç†å™¨")

# è®¢é˜…äº‹ä»¶
event_bus.subscribe("temp.event", temporary_handler)

# ... æ‰§è¡Œä¸€äº›æ“ä½œ ...

# å–æ¶ˆè®¢é˜…
event_bus.unsubscribe("temp.event", temporary_handler)
```

**é—®ï¼šäº‹ä»¶åå†²çªæ€ä¹ˆåŠï¼Ÿ**

ä½¿ç”¨å‘½åç©ºé—´æ¥åŒºåˆ†ä¸åŒæ¨¡å—çš„äº‹ä»¶ã€‚è°ƒç”¨ `set_event_namespace("module_name")` è®¾ç½®æ¨¡å—å‘½åç©ºé—´ï¼Œæ‰€æœ‰è¯¥æ¨¡å—ä¸‹çš„äº‹ä»¶éƒ½ä¼šè‡ªåŠ¨æ·»åŠ å‰ç¼€ã€‚

**é—®ï¼šå¯ä»¥åœ¨äº‹ä»¶å¤„ç†å™¨ä¸­å‘å¸ƒæ–°äº‹ä»¶å—ï¼Ÿ**

å®Œå…¨å¯ä»¥ï¼äº‹ä»¶å¤„ç†å™¨ä¸­å¯ä»¥å‘å¸ƒä»»æ„äº‹ä»¶ï¼Œè¿™æ­£æ˜¯äº‹ä»¶æ¨¡å¼çš„å¼ºå¤§ä¹‹å¤„ã€‚å¤šä¸ªå¤„ç†å™¨å¯ä»¥å½¢æˆäº‹ä»¶é“¾ï¼Œä¸€ä¸ªäº‹ä»¶è§¦å‘å¦ä¸€ä¸ªäº‹ä»¶ã€‚

**é—®ï¼šäº‹ä»¶å¤„ç†æœ‰æ€§èƒ½é—®é¢˜å—ï¼Ÿ**

Cellium çš„äº‹ä»¶æ€»çº¿ç»è¿‡ä¼˜åŒ–ï¼Œå¯¹äºå¤§å¤šæ•°åœºæ™¯æ€§èƒ½æ˜¯å®Œå…¨è¶³å¤Ÿçš„ã€‚å¦‚æœä½ çš„åº”ç”¨æœ‰æé«˜çš„æ€§èƒ½è¦æ±‚ï¼Œå»ºè®®ï¼šé¿å…åœ¨äº‹ä»¶å¤„ç†ä¸­è¿›è¡Œè€—æ—¶æ“ä½œã€ä½¿ç”¨å¼‚æ­¥å¤„ç†å™¨å¤„ç†è€—æ—¶ä»»åŠ¡ã€åˆç†è®¾ç½®ä¼˜å…ˆçº§è®©é‡è¦äº‹ä»¶ä¼˜å…ˆå¤„ç†ã€‚

## 10. å­¦ä¹ è·¯å¾„å»ºè®®

æŒæ¡äº†äº‹ä»¶æ¨¡å¼åï¼Œä½ å¯ä»¥ç»§ç»­æ·±å…¥å­¦ä¹ ä»¥ä¸‹å†…å®¹ï¼š

- **å¼‚æ­¥äº‹ä»¶å¤„ç†**ï¼šå­¦ä¹ å¦‚ä½•ä½¿ç”¨å¼‚æ­¥äº‹ä»¶å¤„ç†å™¨ï¼Œæé«˜åº”ç”¨æ€§èƒ½
- **äº‹ä»¶åˆ†ç±»ç®¡ç†**ï¼šå­¦ä¹ å¦‚ä½•ç»„ç»‡å¤§é‡çš„äº‹ä»¶å¤„ç†å™¨ï¼Œä¿æŒä»£ç æ•´æ´
- **äº‹ä»¶æµ‹è¯•**ï¼šå­¦ä¹ å¦‚ä½•ä¸ºäº‹ä»¶ç³»ç»Ÿç¼–å†™å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿ä»£ç è´¨é‡

> ğŸ’¡ **æ€»ç»“**ï¼šäº‹ä»¶æ¨¡å¼æ˜¯ Cellium ä¸­éå¸¸å¼ºå¤§çš„åŠŸèƒ½ï¼Œå®ƒè®©ä½ çš„åº”ç”¨å„éƒ¨åˆ†å¯ä»¥æ¾è€¦åˆåœ°é€šä¿¡ã€‚ä¸€ä¸ªå¥½çš„äº‹ä»¶ç³»ç»Ÿå¯ä»¥è®©ä½ çš„ä»£ç æ›´åŠ æ¸…æ™°ã€çµæ´»å’Œå¯ç»´æŠ¤ã€‚å¸Œæœ›è¿™ç¯‡æ•™ç¨‹èƒ½å¸®åŠ©ä½ å¾ˆå¥½åœ°ç†è§£å’Œä½¿ç”¨äº‹ä»¶æ¨¡å¼ã€‚ç¥ä½ å¼€å‘æ„‰å¿«ï¼

## 11. å®Œæ•´æ–‡ä»¶æ¸…å•

æœ¬æ•™ç¨‹æ¶‰åŠçš„æ–‡ä»¶ï¼š

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|----------|------|
| `app/core/bus/event_bus.py` | äº‹ä»¶æ€»çº¿æ ¸å¿ƒå®ç° |
| `app/core/bus/__init__.py` | äº‹ä»¶æ¨¡å—å¯¼å‡º |
| `docs/event-mode-tutorial.md` | äº‹ä»¶æ¨¡å¼æ•™ç¨‹ï¼ˆæœ¬æ–‡æ¡£ï¼‰ |
| `docs/event-mode-tutorial.en.md` | äº‹ä»¶æ¨¡å¼æ•™ç¨‹ï¼ˆè‹±æ–‡ç‰ˆï¼‰ |
| `docs/component-tutorial.md` | ç»„ä»¶å¼€å‘æ•™ç¨‹ï¼ˆå»ºè®®é…åˆå­¦ä¹ ï¼‰ |

---

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
